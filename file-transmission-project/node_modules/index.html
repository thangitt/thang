<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ứng Dụng Truyền File Ký Số</title>
    <link href="output.css" rel="stylesheet">
    <style>
        body {
            background-color: #f3f4f6;
            height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        .container {
            background-color: white;
            padding: 2rem;
            border-radius: 0.5rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            width: 400px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1 class="text-2xl font-bold text-center mb-4">Truyền File Ký Số</h1>
        <input type="file" id="fileInput" class="block w-full mb-4 p-2 border rounded" onchange="handleFileSelect(event)">
        <button onclick="transmitFile()" class="w-full bg-blue-500 text-white p-2 rounded hover:bg-blue-600">Truyền File</button>
        <div id="status" class="mt-4 text-center text-green-600"></div>
        <div id="signature" class="mt-2 text-center text-gray-600"></div>
    </div>

    <script>
        let selectedFile = null;
        let ws;

        function initWebSocket() {
            ws = new WebSocket('ws://localhost:8080');
            ws.onopen = () => {
                console.log('Kết nối WebSocket thành công');
                document.getElementById('status').innerText = 'Kết nối thành công, sẵn sàng truyền!';
            };

            ws.onmessage = (event) => {
                document.getElementById('status').innerText = event.data;
            };

            ws.onerror = (error) => {
                console.error('Lỗi WebSocket:', error);
                document.getElementById('status').innerText = 'Lỗi kết nối WebSocket! Vui lòng kiểm tra server.';
            };

            ws.onclose = () => {
                console.log('Kết nối WebSocket đóng');
                document.getElementById('status').innerText = 'Kết nối đã đóng. Thử lại sau!';
            };
        }

        window.onload = initWebSocket; // Khởi tạo WebSocket khi trang tải

        function handleFileSelect(event) {
            selectedFile = event.target.files[0];
            document.getElementById('status').innerText = `Đã chọn: ${selectedFile.name}`;
        }

        function generateSignature(fileData) {
            return btoa(fileData.substring(0, 10)) + '-signature'; // Mô phỏng ký số
        }

        function transmitFile() {
            if (!selectedFile) {
                document.getElementById('status').innerText = 'Vui lòng chọn file trước!';
                return;
            }

            if (ws.readyState !== WebSocket.OPEN) {
                document.getElementById('status').innerText = 'Kết nối WebSocket chưa sẵn sàng! Đang thử lại...';
                initWebSocket();
                setTimeout(transmitFile, 1000); // Thử lại sau 1 giây
                return;
            }

            const reader = new FileReader();
            reader.onload = function(e) {
                const fileData = e.target.result;
                const signature = generateSignature(fileData);
                document.getElementById('signature').innerText = `Ký số: ${signature}`;

                ws.send(JSON.stringify({ fileName: selectedFile.name, data: fileData, signature: signature }));
                document.getElementById('status').innerText = `Đang truyền ${selectedFile.name}...`;
            };
            reader.readAsDataURL(selectedFile);
        }
    </script>